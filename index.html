<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Adaptiv (Flyt) — Fact Families</title>
<style>
  :root{
    --bg:#0b1020; --card:#0f172a; --ink:#e5e7eb; --muted:#9aa3b2; --ring:#334155;
    --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --bar:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:480px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px}

  /* Headings */
  h1{font-size:20px;margin:6px 0 2px;text-align:center;color:#fcd34d}
  .pageH{font-weight:900;margin-bottom:6px;color:#fcd34d;font-size:16px}

  /* Cards & controls */
  .card{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}

  .chips{display:flex;gap:6px;overflow:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .chips::-webkit-scrollbar{display:none}
  .chip{flex:0 0 auto;border:1px solid var(--ring);background:#0b1223;color:var(--ink);
        border-radius:999px;padding:10px 12px;font-weight:800}
  .chip.active{border-color:var(--ok);box-shadow:0 0 0 2px #14532d inset}
  .chip.big{font-size:16px}
  .chip.small{padding:6px 10px;font-size:12px}

  .btn{border:1px solid var(--ring);background:#0b1223;color:var(--ink);border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
  .btn.primary{border-color:var(--ok)}
  .btn.warn{border-color:var(--warn)}
  .btn.stop{border-color:var(--err)}
  .btn.big{width:100%;padding:12px;font-size:18px}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  .stage{display:flex;align-items:center;justify-content:center;text-align:center;border:1px solid var(--ring);border-radius:12px;padding:16px;background:radial-gradient(600px 200px at 50% -40%, #22c55e12, transparent 60%)}
  .eq{display:flex;align-items:center;justify-content:center;gap:10px;font-size:clamp(28px,8vw,40px);user-select:none}
  .numbox{width:5.2ch;height:2.2em;border-radius:12px;border:3px solid #374151;background:#0b1223;color:var(--ink);font-weight:900;text-align:center;font-size:1em}
  .numbox.ok{border-color:#22c55e;background:#052e15;color:#c7f9d4}
  .numbox.err{border-color:#ef4444;background:#3b0a0a;color:#fecaca}
  .numbox::-webkit-outer-spin-button,.numbox::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input.numbox{-moz-appearance:textfield}

  .tbig{font-variant-numeric:tabular-nums;font-weight:900;font-size:22px}
  .progress{height:10px;background:var(--bar);border-radius:999px;overflow:hidden;border:1px solid #334155}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#16a34a);transition:width .2s ease}

  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
  .stat{background:#0b1223;border:1px solid var(--ring);border-radius:10px;padding:8px;text-align:center}
  .lab{font-size:10px;color:#9aa3b2;letter-spacing:.3px}
  .val{font-variant-numeric:tabular-nums;font-weight:900;font-size:18px}

  .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .key{border:1px solid var(--ring);background:#0b1223;color:#e5e7eb;border-radius:12px;padding:12px 0;font-weight:900;font-size:18px}
  .key:active{transform:translateY(1px) scale(.99)}

  .muted{color:#9aa3b2;font-size:12px}
  .good{color:#86efac}
  .bad{color:#fecaca}

  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:6px;border-bottom:1px solid #22314a}
  th{text-align:left;color:#cbd5e1;position:sticky;top:0;background:#0f172a}
  td.right{text-align:right}

  .levelChip{border:1px solid #334155;background:#0b1223;border-radius:999px;padding:4px 8px;font-size:12px;font-weight:900}
  .hintbox{border:1px dashed #334155;border-radius:10px;padding:8px;background:#0b1223;font-size:12px;color:#cbd5e1}

  /* ⚡ BIG round result flash */
  #roundPopup{position:fixed;inset:0;display:none;place-items:center;z-index:30;pointer-events:none}
  #roundPopup .flash{
    display:flex;align-items:center;gap:0.4em;
    font-size:clamp(48px,16vw,110px);font-weight:1000;letter-spacing:.5px;
    padding:.15em .35em;border-radius:18px;border:2px solid #d9b63a;
    color:#fde68a;background:radial-gradient(600px 200px at 50% -30%, rgba(252,211,77,.15), transparent 60%), #0b1223;
    box-shadow:0 10px 40px rgba(0,0,0,.45), 0 0 0 6px rgba(252,211,77,.08);
    transform:scale(.92);opacity:.98;animation:pop 650ms ease-out both;
  }
  #roundPopup .flash.err{
    border-color:#ef4444;color:#fecaca;
    box-shadow:0 10px 40px rgba(0,0,0,.45), 0 0 0 6px rgba(239,68,68,.12);
  }
  .bolt{filter:drop-shadow(0 2px 2px rgba(0,0,0,.35))}
  @keyframes pop{
    0%{transform:scale(.85);opacity:.0}
    60%{transform:scale(1.03);opacity:1}
    100%{transform:scale(1);opacity:1}
  }

  /* preview block (første runde på nytt nivå) */
  .pv{display:flex;flex-direction:column;align-items:center;gap:8px}
  .pv-block{background:#0b1223;border:1px dashed var(--ring);border-radius:10px;padding:8px 10px;width:100%;max-width:360px}
  .pv-title{font-size:12px;color:#9aa3b2;text-align:center;margin-bottom:4px}
  .pv-line{font-weight:900;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="mainTitle">Adaptiv (Flyt) — husk nivået ditt!</h1>

  <!-- HOME -->
  <div id="home" class="card">
    <div class="pageH">Start</div>
    <div class="hintbox" style="margin-bottom:8px">
      Nivåkoder: <b>A5–A20</b> (summer) og <b>M2–M12</b> (gangetabeller).<br>
      Tips: <i>Husk nivået ditt</i> (f.eks. <b>A7</b> eller <b>M5</b>) for rask start på en ny enhet.
    </div>

    <div class="chips" id="domainChips" style="margin-bottom:8px">
      <button class="chip active" data-domain="add">Pluss/Minus (A5–A20)</button>
      <button class="chip" data-domain="mul">Gange/Deling (M2–M12)</button>
    </div>

    <div class="grid2" style="margin-bottom:8px">
      <button id="btnContinue" class="btn" disabled>Fortsett nivå</button>
      <button id="btnPlacement" class="btn primary">Start placement test</button>
    </div>

    <div class="row" style="gap:8px">
      <input id="levelInput" type="text" placeholder="Skriv nivå (A7 eller M5)" 
             style="flex:1;background:#0b1223;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:10px 12px;font-weight:800">
      <button id="btnJump" class="btn">Gå</button>
    </div>

    <div class="muted" id="lastInfo" style="margin-top:8px"></div>
  </div>

  <!-- PLACEMENT -->
  <div id="placement" class="card" style="display:none">
    <div class="pageH">Placement test</div>
    <div class="muted" id="plNote" style="margin-bottom:6px">Runde <b id="plIdx">1</b>/4 – 20 sek</div>

    <div class="row" style="justify-content:space-between;margin-bottom:6px">
      <div class="levelChip" id="plGroupName">—</div>
      <div class="tbig" id="plTime">00:20</div>
    </div>
    <div class="progress" style="margin-bottom:8px"><div id="plBar" class="bar"></div></div>

    <div class="stage">
      <div id="plEq" class="eq">Klar?</div>
    </div>

    <div class="stats">
      <div class="stat"><div class="lab">Riktige</div><div id="plOK" class="val">0</div></div>
      <div class="stat"><div class="lab">Feil</div><div id="plBad" class="val">0</div></div>
    </div>

    <div class="keypad" id="plPad" style="margin-top:8px"></div>

    <div class="grid2" style="margin-top:8px">
      <button id="plPause" class="btn warn">Pause</button>
      <button id="plAbort" class="btn stop">Avbryt</button>
    </div>
  </div>

  <!-- PLAY (FLOW) -->
  <div id="play" class="card" style="display:none">
    <div class="pageH">Practice</div>

    <div class="row" style="justify-content:space-between;margin-bottom:6px">
      <div class="row" style="gap:6px;align-items:center">
        <span class="levelChip">Nivå <b id="levelCode">A7</b></span>
        <span class="muted" id="mixTag" style="display:none">Miksrunde</span>
      </div>
      <div class="tbig" id="timeLeft">00:30</div>
    </div>
    <div class="progress" style="margin-bottom:8px"><div id="timeBar" class="bar"></div></div>

    <div class="stage">
      <div id="eq" class="eq">Tap for å starte</div>
    </div>

    <div class="stats">
      <div class="stat"><div class="lab">Riktige</div><div id="correct" class="val">0</div></div>
      <div class="stat"><div class="lab">Feil</div><div id="wrong" class="val">0</div></div>
    </div>

    <div class="keypad" id="keypad" style="margin-top:8px"></div>

    <div class="grid2" style="margin-top:8px">
      <button id="pauseBtn" class="btn warn">Pause</button>
      <button id="stopBtn" class="btn stop">Stopp</button>
    </div>

    <div class="muted" id="flowHint" style="margin-top:6px"></div>
  </div>

  <!-- SUMMARY -->
  <div id="summary" class="card" style="display:none">
    <div class="pageH">Øktsammendrag</div>
    <table>
      <thead>
      <tr><th>Tid</th><th>Nivå</th><th>✓</th><th>✗</th><th class="right">s</th><th class="right">CPM</th><th>Flyt</th></tr>
      </thead>
      <tbody id="resBody"></tbody>
    </table>
    <div class="grid2" style="margin-top:8px">
      <button id="sumContinue" class="btn primary">Fortsett</button>
      <button id="sumHome" class="btn">Hjem</button>
    </div>
  </div>
</div>

<!-- ⚡ BIG CPM flash -->
<div id="roundPopup" aria-live="polite" aria-hidden="true">
  <div id="flashWrap" class="flash"><span class="bolt">⚡</span><span id="flashNum">0.0</span></div>
</div>

<script>
(function(){
'use strict';

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const pad = n => String(n).padStart(2,'0');
const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
const fmtTime = s => { s=Math.max(0,Math.ceil(s)); return `${pad(Math.floor(s/60))}:${pad(s%60)}`; };
const nowClock = ()=>{ const d=new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; };

/* ---------- Families ---------- */
// Add: c=2..20, a<=b
const F_ADD=[]; for(let c=2;c<=20;c++){ for(let a=1;a<=Math.floor(c/2);a++){ const b=c-a; F_ADD.push({a,b,c,id:`A:${a}-${b}-${c}`}); } }
// Mul: a<=b<=12
const F_MUL=[]; for(let a=1;a<=12;a++){ for(let b=a;b<=12;b++){ const c=a*b; F_MUL.push({a,b,c,id:`M:${a}-${b}-${c}`}); } }

const famItemsAdd=f=>[
  {op:'+', pattern:[f.a,f.b,f.c], fam:f.id},
  {op:'+', pattern:[f.b,f.a,f.c], fam:f.id},
  {op:'-', pattern:[f.c,f.a,f.b], fam:f.id},
  {op:'-', pattern:[f.c,f.b,f.a], fam:f.id},
];
const famItemsMul=f=>[
  {op:'×', pattern:[f.a,f.b,f.c], fam:f.id},
  {op:'×', pattern:[f.b,f.a,f.c], fam:f.id},
  {op:'÷', pattern:[f.c,f.a,f.b], fam:f.id},
  {op:'÷', pattern:[f.c,f.b,f.a], fam:f.id},
];

/* ---------- Flow state (persist) ---------- */
const KEY='ff_v2_flow_progress_v1';
let flow = {
  domain:'add',            // 'add' | 'mul'
  placementDone:false,
  currentLevel:null,       // 'A7' or 'M5'
  streak:0,                // consecutive flyt passes on currentLevel
  mastered:[],             // ['A6','A7',...]
  mixWith:null,            // previous mastered to mix with
  mixPending:false,        // schedule a mix round after mastering second family
  lastCpm:0,
};
function loadFlow(){
  try{ const raw=localStorage.getItem(KEY); if(raw){ flow = Object.assign(flow, JSON.parse(raw)); } }catch(e){}
}
function saveFlow(){ try{ localStorage.setItem(KEY, JSON.stringify(flow)); }catch(e){} }

/* ---------- Screens ---------- */
function show(id){
  ['home','placement','play','summary'].forEach(x=>$(x).style.display='none');
  $(id).style.display='';
  $('mainTitle').style.display = (id==='home') ? '' : 'none';
}

/* ---------- Domain chips ---------- */
$('domainChips').addEventListener('click',e=>{
  const b=e.target.closest('.chip'); if(!b) return;
  [...$('domainChips').querySelectorAll('.chip')].forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const d=b.dataset.domain;
  flow.domain=d; saveFlow();
  updateHomeButtons();
});

/* ---------- Home: Continue / Jump ---------- */
function updateHomeButtons(){
  const has = flow.currentLevel && flow.currentLevel.startsWith(flow.domain==='add'?'A':'M');
  $('btnContinue').disabled = !has;
  $('lastInfo').textContent = has ? `Sist lagret nivå: ${flow.currentLevel}` : '';
  $('levelInput').placeholder = flow.domain==='add' ? 'Skriv nivå (A7…A20)' : 'Skriv nivå (M2…M12)';
}
$('btnContinue').addEventListener('click',()=>{
  if(!flow.currentLevel) return;
  startLevel(flow.currentLevel, /*preview=*/true);
});
$('btnJump').addEventListener('click',()=>{
  const code = ($('levelInput').value||'').trim().toUpperCase();
  if(!validateLevelCode(code)){ alert('Ugyldig nivå. Bruk A5–A20 eller M2–M12.'); return; }
  flow.currentLevel = code;
  flow.domain = code.startsWith('A') ? 'add':'mul';
  flow.placementDone = true;
  flow.streak = 0; flow.mixWith=null; flow.mixPending=false;
  saveFlow();
  startLevel(flow.currentLevel, /*preview=*/true);
});

/* ---------- Level code helpers ---------- */
function validateLevelCode(code){
  if(/^A(1?\d|20)$/.test(code)){ const n=+code.slice(1); return n>=5 && n<=20; }
  if(/^M(1?\d|12)$/.test(code)){ const n=+code.slice(1); return n>=2 && n<=12; }
  return false;
}
function levelNumber(code){ return +code.slice(1); }

/* ---------- Placement test ---------- */
const PL_GROUPS_ADD = [
  {label:'Summer 2–6', sums:[2,3,4,5,6]},
  {label:'Summer 7–10', sums:[7,8,9,10]},
  {label:'Summer 11–15', sums:[11,12,13,14,15]},
  {label:'Summer 16–20', sums:[16,17,18,19,20]},
];
const PL_GROUPS_MUL = [
  {label:'2–4-gangen',   factors:[2,3,4]},
  {label:'5–7-gangen',   factors:[5,6,7]},
  {label:'8–9-gangen',   factors:[8,9]},
  {label:'10–12-gangen', factors:[10,11,12]},
];

let plIdx=0, plDur=20, plRunning=false, plPaused=false, plStart=0, plPauseMs=0, plTick=null;
let plCorrect=0, plWrong=0, plQ=[], plI=0, plSol=0, plCur=null;
let plStats={}; // per sum or table: {ok, bad, time}

/* Build placement queue for a group */
function buildPlacementQueue(){
  const list = (flow.domain==='add') ? F_ADD : F_MUL;
  const g = (flow.domain==='add') ? PL_GROUPS_ADD[plIdx] : PL_GROUPS_MUL[plIdx];
  const chosenFamilies = (flow.domain==='add')
    ? list.filter(f=>g.sums.includes(f.c)) // all families whose sum c is in group
    : list.filter(f=>g.factors.includes(f.a) || g.factors.includes(f.b)); // families belonging to chosen tables
  const items=[];
  (flow.domain==='add'?chosenFamilies:chosenFamilies).forEach(f=>{
    items.push(...(flow.domain==='add'?famItemsAdd(f):famItemsMul(f)));
  });
  shuffle(items);
  // Limit queue to keep round varied but finite
  return items.slice(0,200);
}

/* Placement round engine */
function plInputHTML(){ return `<input id="plAns" class="numbox" type="text" inputmode="numeric" autocomplete="off" pattern="[0-9]*">`; }
function plSetEq(item){
  plCur=item;
  const [x,y,z]=item.pattern, op=item.op;
  const miss=Math.floor(Math.random()*3);
  $('plEq').innerHTML = [
    miss===0?plInputHTML():`<span>${x}</span>`,
    `<span>${op}</span>`,
    miss===1?plInputHTML():`<span>${y}</span>`,
    `<span>=</span>`,
    miss===2?plInputHTML():`<span>${z}</span>`
  ].join('');
  plSol=[x,y,z][miss];

  const inp=$('plAns'); if(inp){
    const blockKeys = e => { if(['ArrowUp','ArrowDown','PageUp','PageDown'].includes(e.key)) e.preventDefault(); };
    const blockWheel = e => e.preventDefault();
    inp.addEventListener('keydown', blockKeys, {passive:false});
    inp.addEventListener('wheel', blockWheel, {passive:false});
    inp.addEventListener('input', ()=>{
      inp.value = inp.value.replace(/\D+/g,'').slice(0,3);
      plOnType();
    });
    inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); plSubmit(); } });
    inp.focus({preventScroll:true});
  }
}
function plOnType(){
  if(!plRunning || plPaused) return;
  const inp=$('plAns'); if(!inp) return;
  const v=inp.value.trim(); if(v==='') return;
  const need=String(plSol).length;
  if(v.length>=need || +v===plSol){ plSubmit(); }
}
function plSubmit(){
  if(!plRunning||plPaused) return;
  const v=$('plAns')?.value?.trim(); if(v==='') return;
  const ok=(+v===plSol); const key = (flow.domain==='add') ? String(plCur.pattern[2]) : (plCur.pattern[0]===plCur.pattern[1] ? plCur.pattern[0] : (plCur.pattern[0] < plCur.pattern[1] ? plCur.pattern[0] : plCur.pattern[1]));
  if(ok){ plCorrect++; $('plOK').textContent=String(plCorrect); }
  else{ plWrong++; $('plBad').textContent=String(plWrong); }
  // accumulate per-sum or per-table stats
  if(!plStats[key]) plStats[key]={ok:0,bad:0};
  if(ok) plStats[key].ok++; else plStats[key].bad++;

  plI++;
  if(plI>=plQ.length){ plQ = plQ.concat(buildPlacementQueue()); }
  plSetEq(plQ[plI]);
}
function startPlacementRound(){
  plCorrect=0; plWrong=0; $('plOK').textContent='0'; $('plBad').textContent='0';
  $('plIdx').textContent=String(plIdx+1);
  const group = (flow.domain==='add') ? PL_GROUPS_ADD[plIdx] : PL_GROUPS_MUL[plIdx];
  $('plGroupName').textContent = group.label;
  $('plTime').textContent = fmtTime(plDur);
  $('plBar').style.width='0%';
  plQ = buildPlacementQueue(); plI=0; plSetEq(plQ[plI]);

  plRunning=true; plPaused=false; plStart=Date.now(); plPauseMs=0;
  if(plTick) clearInterval(plTick);
  plTick=setInterval(()=>{
    if(!plRunning||plPaused) return;
    const e=((Date.now()-plStart)-plPauseMs)/1000;
    const left=Math.max(0, plDur-e);
    $('plTime').textContent=fmtTime(left);
    $('plBar').style.width = Math.min(100, (e/plDur)*100) + '%';
    if(e>=plDur){ finishPlacementRound(); }
  },100);
}
function finishPlacementRound(){
  plRunning=false; if(plTick) clearInterval(plTick);
  // proceed to next group
  plIdx++;
  if(plIdx<4){
    startPlacementRound();
  }else{
    // decide start level
    const startCode = decideStartLevelFromPlacement();
    flow.currentLevel = startCode;
    flow.placementDone = true;
    flow.streak = 0; flow.mixWith=null; flow.mixPending=false;
    saveFlow();
    startLevel(startCode, /*preview=*/true);
    // reset placement state
    plIdx=0; plStats={};
  }
}
$('plPause').addEventListener('click',()=>{
  if(!plRunning) return;
  plPaused = !plPaused;
  if(!plPaused){ plPauseMs += Date.now() - (plStart + plPauseMs + (plDur*1000 - (plDur*1000 - 0))); } // keep simple
});
$('plAbort').addEventListener('click',()=>{ plRunning=false; if(plTick) clearInterval(plTick); show('home'); });

/* Decide start level from plStats */
function decideStartLevelFromPlacement(){
  // Build score per key
  // For add: key = sum c; For mul: key = factor table (use factor itself)
  const entries = Object.entries(plStats).map(([k,v])=>{
    const ok=v.ok||0, bad=v.bad||0;
    const attempts=ok+bad;
    const cpm = attempts * (60/plDur); // approx since all within 20s
    const score = cpm - 5*bad; // simple
    return {key:+k, ok, bad, attempts, cpm, score};
  });
  if(entries.length===0){
    // fallback
    return flow.domain==='add' ? 'A7' : 'M5';
    }
  // Prefer keys with <=1 feil, choose highest cpm; else best score
  let candidates = entries.filter(e=>e.bad<=1);
  if(candidates.length===0) candidates = entries;
  candidates.sort((a,b)=> b.cpm - a.cpm || b.score - a.score);

  const best = candidates[0];
  if(flow.domain==='add'){
    let c = best.key;
    // if this was very lett (proxy): bump ett trinn
    if(best.cpm >= 28 && best.bad===0) c = Math.min(20, c+1);
    c = Math.max(5, Math.min(20, c));
    return 'A'+c;
  }else{
    let t = best.key;
    if(best.cpm >= 20 && best.bad===0) t = Math.min(12, t+1);
    t = Math.max(2, Math.min(12, t));
    return 'M'+t;
  }
}

/* ---------- Flow play engine ---------- */
const ROUND_SEC = 30;
const ERROR_LIMIT = 3;

let running=false, paused=false, waitingTap=false;
let startMs=0, pauseMs=0, pauseStart=0, tick=null;
let correct=0, wrong=0, idx=0, q=[], cur=null, sol=0;
let results=[]; // for session table

function inputHTML(){ return `<input id="ans" class="numbox" type="text" inputmode="numeric" autocomplete="off" pattern="[0-9]*">`; }
function setEq(item){
  cur=item;
  const [x,y,z]=item.pattern, op=item.op;
  const miss=Math.floor(Math.random()*3);
  $('eq').innerHTML = [
    miss===0?inputHTML():`<span>${x}</span>`,
    `<span>${op}</span>`,
    miss===1?inputHTML():`<span>${y}</span>`,
    `<span>=</span>`,
    miss===2?inputHTML():`<span>${z}</span>`
  ].join('');
  sol=[x,y,z][miss];

  const inp=$('ans'); if(inp){
    const blockKeys = e => { if(['ArrowUp','ArrowDown','PageUp','PageDown'].includes(e.key)) e.preventDefault(); };
    const blockWheel = e => e.preventDefault();
    inp.addEventListener('keydown', blockKeys, {passive:false});
    inp.addEventListener('wheel', blockWheel, {passive:false});
    inp.addEventListener('input', ()=>{
      inp.value = inp.value.replace(/\D+/g,'').slice(0,3);
      onType();
    });
    inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); submit(); } });
    inp.focus({preventScroll:true});
  }
}
function mark(ok){
  const inp=$('ans'); if(!inp) return;
  inp.classList.remove('ok','err');
  inp.classList.add(ok?'ok':'err');
}

function buildQueueForLevel(code, mixWith=null){
  const items=[];
  if(code.startsWith('A')){
    const c=+code.slice(1);
    const fams = F_ADD.filter(f=>f.c===c);
    fams.forEach(f=> items.push(...famItemsAdd(f)));
    if(mixWith){
      const cm=+mixWith.slice(1);
      const fams2=F_ADD.filter(f=>f.c===cm);
      const items2=[]; fams2.forEach(f=> items2.push(...famItemsAdd(f)));
      // 50/50 miks
      const blend=[]; const a=items.length, b=items2.length;
      const L=Math.max(a,b);
      for(let i=0;i<L;i++){ if(i<a) blend.push(items[i]); if(i<b) blend.push(items2[i]); }
      return shuffle(blend);
    }
    return shuffle(items);
  }else{
    const t=+code.slice(1);
    const fams = F_MUL.filter(f=>f.a===t || f.b===t);
    fams.forEach(f=> items.push(...famItemsMul(f)));
    if(mixWith){
      const tm=+mixWith.slice(1);
      const fams2=F_MUL.filter(f=>f.a===tm || f.b===tm);
      const items2=[]; fams2.forEach(f=> items2.push(...famItemsMul(f)));
      const blend=[]; const a=items.length, b=items2.length;
      const L=Math.max(a,b);
      for(let i=0;i<L;i++){ if(i<a) blend.push(items[i]); if(i<b) blend.push(items2[i]); }
      return shuffle(blend);
    }
    return shuffle(items);
  }
}

function nextItem(){
  if(idx>=q.length){ q=q.concat(q); } // keep replenishing with same composition
  setEq(q[idx]); hud();
}
function onType(){
  if(!running || paused) return;
  const inp=$('ans'); if(!inp) return;
  const v=inp.value.trim(); if(v==='') return;
  const need=String(sol).length;
  if(v.length>=need || +v===sol){ submit(); }
}
function submit(){
  if(!running||paused) return;
  const v=$('ans')?.value?.trim(); if(v==='') return;
  const ok=(+v===sol);
  if(ok){ correct++; mark(true); idx++; setTimeout(nextItem,70); hud(); return; }
  wrong++; mark(false);
  if(wrong>ERROR_LIMIT){ idx++; finishRound('errors'); return; }
  q.splice(idx+1,0,cur); idx++; setTimeout(nextItem,70); hud();
}

/* Preview four facts for level (first round on new level only) */
function previewLinesForFamily(f, dom){
  if(dom==='add'){
    return [`${f.a}+${f.b}=${f.c}`,`${f.b}+${f.a}=${f.c}`,`${f.c}-${f.a}=${f.b}`,`${f.c}-${f.b}=${f.a}`];
  }else{
    return [`${f.a}×${f.b}=${f.c}`,`${f.b}×${f.a}=${f.c}`,`${f.c}÷${f.a}=${f.b}`,`${f.c}÷${f.b}=${f.a}`];
  }
}
function renderPreviewForLevel(code){
  const dom = code.startsWith('A')?'add':'mul';
  const block = document.createElement('div'); block.className='pv';
  if(dom==='add'){
    const c=+code.slice(1), fam = F_ADD.find(f=>f.c===c);
    if(fam){
      const lines = previewLinesForFamily(fam,'add');
      block.innerHTML = `<div class="pv-block">
        <div class="pv-title">Fakta for Sum ${c}</div>
        ${lines.map(l=>`<div class="pv-line">${l}</div>`).join('')}
      </div>
      <button id="tapToStartBtn" class="btn primary big" style="margin-top:8px">Tap for å starte</button>`;
    }
  }else{
    const t=+code.slice(1), fam = F_MUL.find(f=>f.a===t || f.b===t);
    if(fam){
      const lines = previewLinesForFamily(fam,'mul');
      block.innerHTML = `<div class="pv-block">
        <div class="pv-title">${t}-gangen</div>
        ${lines.map(l=>`<div class="pv-line">${l}</div>`).join('')}
      </div>
      <button id="tapToStartBtn" class="btn primary big" style="margin-top:8px">Tap for å starte</button>`;
    }
  }
  $('eq').innerHTML=''; $('eq').appendChild(block);
  $('tapToStartBtn')?.addEventListener('click', startTimedRound, {once:true});
  document.addEventListener('keydown', onEnterStart, {once:true});
}
function onEnterStart(e){ if(e.key==='Enter'){ e.preventDefault(); startTimedRound(); } }

function startLevel(code, preview){
  show('play');
  $('levelCode').textContent = code;
  $('mixTag').style.display = flow.mixPending ? '' : 'none';
  $('flowHint').textContent = 'To runder på rad med flyt → neste nivå.';
  correct=0; wrong=0; $('correct').textContent='0'; $('wrong').textContent='0';
  $('timeBar').style.width='0%'; $('timeLeft').textContent=fmtTime(ROUND_SEC);
  // queue
  q = buildQueueForLevel(code, flow.mixPending ? flow.mixWith : null); idx=0;
  if(preview && !flow.mixPending){ waitingTap=true; renderPreviewForLevel(code); }
  else { waitingTap=false; setTimeout(startTimedRound, 300); }
}

/* Round control */
function startTimedRound(){
  waitingTap=false;
  running=true; paused=false; startMs=Date.now(); pauseMs=0; pauseStart=0;
  setEq(q[idx]);
  if(tick) clearInterval(tick);
  tick=setInterval(()=>{
    if(!running||paused) return;
    hud();
    const e=((Date.now()-startMs)-pauseMs)/1000;
    if(e>=ROUND_SEC){ finishRound('time'); }
  },100);
}
function elapsed(){ return ((paused?pauseStart:Date.now())-startMs - pauseMs)/1000; }
function hud(){
  const e=elapsed();
  $('correct').textContent = String(correct);
  $('wrong').textContent   = String(wrong);
  const left = Math.max(0, ROUND_SEC - e);
  $('timeLeft').textContent = fmtTime(left);
  $('timeBar').style.width = Math.max(0, Math.min(100, (e/ROUND_SEC)*100)) + '%';
}

/* Flyt-kriterier */
function cpmThreshold(code){
  if(code.startsWith('A')){
    const c=+code.slice(1);
    return (c<=10)?24:20;
  }else{
    const t=+code.slice(1);
    if(t<=5) return 18;
    if(t<=8) return 16;
    return 14;
  }
}
function passedFlow(code, cpm, errors){
  return cpm >= cpmThreshold(code) && errors <= 1;
}

/* BIG flash */
function showRoundFlash(cpm, endedByErrors){
  const pop = $('roundPopup');
  const wrap = $('flashWrap');
  $('flashNum').textContent = (isFinite(cpm)?cpm.toFixed(1):'0.0');
  wrap.classList.toggle('err', !!endedByErrors);
  wrap.style.animation='none'; void wrap.offsetHeight; wrap.style.animation='';
  pop.style.display='grid'; pop.setAttribute('aria-hidden','false');
  setTimeout(()=>{ pop.style.display='none'; pop.setAttribute('aria-hidden','true'); }, 1300);
}

/* Finish */
function finishRound(why){
  const wasRunning = running; running=false; if(tick) clearInterval(tick);
  const e=elapsed(); const cpm = e>0? (correct/(e/60)) : 0;
  flow.lastCpm = +(isFinite(cpm)?cpm.toFixed(1):'0'); saveFlow();

  if(wasRunning){
    $('flowHint').textContent = why==='errors' ? 'Runden stoppet pga. mange feil.' : 'Runde ferdig.';
  }

  // session log table
  const row = {t:nowClock(), lvl:flow.currentLevel + (flow.mixPending?' (mix)':''), ok:correct, bad:wrong, dur:ROUND_SEC, cpm:flow.lastCpm, flyt:'—'};
  const okFlow = passedFlow(flow.currentLevel, flow.lastCpm, wrong);
  row.flyt = okFlow ? '✓' : (why==='errors'?'✗':'');
  results.push(row);

  // flash
  showRoundFlash(flow.lastCpm, why==='errors');

  // Update streak/mastery only if not a mix round
  if(!flow.mixPending){
    if(okFlow){ flow.streak++; } else { flow.streak=0; }
    // Mastered if streak >=2
    if(flow.streak>=2){
      if(!flow.mastered.includes(flow.currentLevel)) flow.mastered.push(flow.currentLevel);
      // Prepare mix when we now have at least 2 mastered
      const prev = flow.mastered.length>=2 ? flow.mastered[flow.mastered.length-2] : null;
      flow.mixWith = prev;
      flow.mixPending = !!prev; // schedule one mix round with previous mastered
      flow.streak=0;
      // Advance to next level
      flow.currentLevel = nextLevel(flow.currentLevel);
      saveFlow();
    }
  }else{
    // consumed scheduled mix
    flow.mixPending=false;
    saveFlow();
  }

  renderSummaryTable();
  // Auto-continue
  setTimeout(()=> startLevel(flow.currentLevel, /*preview=*/!flow.mixPending), 900);
}

/* Next level */
function nextLevel(code){
  if(code.startsWith('A')){
    const c=+code.slice(1);
    return 'A'+ Math.min(20, c+1);
  }else{
    const t=+code.slice(1);
    return 'M'+ Math.min(12, t+1);
  }
}

/* Play controls */
$('pauseBtn').addEventListener('click',()=>{
  if(!running) return;
  if(!paused){ paused=true; pauseStart=Date.now(); $('flowHint').textContent='Pauset'; }
  else{ paused=false; pauseMs += Date.now()-pauseStart; pauseStart=0; $('flowHint').textContent=''; }
});
$('stopBtn').addEventListener('click',()=>{
  if(!running) return;
  finishRound('manual');
});

/* Summary table */
function renderSummaryTable(){
  const body=$('resBody');
  body.innerHTML = results.slice(-10).map(r=>`
    <tr>
      <td>${r.t}</td>
      <td>${r.lvl}</td>
      <td>${r.ok}</td>
      <td>${r.bad}</td>
      <td class="right">${r.dur}</td>
      <td class="right">${(+r.cpm).toFixed(1)}</td>
      <td>${r.flyt}</td>
    </tr>
  `).join('');
}
$('sumContinue').addEventListener('click',()=> startLevel(flow.currentLevel, /*preview=*/!flow.mixPending));
$('sumHome').addEventListener('click',()=> show('home'));

/* Keypads (placement + play) */
function buildPad(containerId, submitFn, typeFn, inputIdGetter){
  const keys=['1','2','3','4','5','6','7','8','9','0','⌫','OK'];
  const pad=$(containerId); pad.innerHTML='';
  keys.forEach(k=>{
    const b=document.createElement('button');
    b.type='button'; b.className='key'; b.textContent=k; b.dataset.key=k;
    pad.appendChild(b);
  });
  pad.addEventListener('click',e=>{
    const btn=e.target.closest('.key'); if(!btn) return;
    const k=btn.dataset.key; const inp=$(inputIdGetter()); if(!inp) return;
    if(k==='OK'){ submitFn(); return; }
    if(k==='⌫'){ inp.value=(inp.value||'').slice(0,-1); typeFn(); return; }
    if(/\d/.test(k)){ inp.value=((inp.value||'')+k).slice(0,3); typeFn(); }
  });
}
buildPad('keypad', submit, onType, ()=> 'ans');
buildPad('plPad', plSubmit, plOnType, ()=> 'plAns');

/* Start placement */
$('btnPlacement').addEventListener('click',()=>{
  results=[]; renderSummaryTable();
  plIdx=0; plStats={};
  show('placement');
  startPlacementRound();
});

/* Init */
function init(){
  loadFlow();
  show('home');
  updateHomeButtons();
}
document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
